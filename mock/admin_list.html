<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>登録者管理画面</title>
  <style>
    .inithide { display: none; }
    table, th, td { border: 1px solid black; border-collapse: collapse; }
    th, td { padding: 5px; }
  </style>
  <script>
<!--
const api_fieldinfo = "fieldinfo.json";
const api_labels = "labels.json";
const api_reginfo = "reginfo.json";
const disp_confirm = '\u2611';
const disp_discard = '\u274c';
const line_head = 'regline_';
let c_fields;
let c_labels;
let cur_reg;
let c_lang = 'ja';
let cur_thead;

function get_data(api, query, callback) {
  fetch(api + '?' + query)
  .then((res) => {
    if (res.ok) { return res.json(); }
    else { throw Error('failed to fetch data'); }
  }).then((res) => {
    callback(res);
  }).catch((e) => {
    window.alert("Data fetch errror (" + api + "): " + e.message);
  });
}

function gendom_textchange(fid, val) {
  fid += '_'; // placeholder
  let cdom = document.createElement('td');
  cdom.id = fid + 'td';
  let ccd, ccdc;
  ccd = document.createElement('span');
  ccd.id = fid + 'cval';
  ccd.innerText = val;
  cdom.appendChild(ccd);
  ccd = document.createElement('span');
  ccd.id = fid + 'edit';
  ccd.className = 'inithide';
  ccdc = document.createElement('input');
  ccdc.type = 'text';
  ccdc.id = fid + 'new';
  ccdc.value = val;
  ccdc.setAttribute('data-orig', val);
  ccd.appendChild(ccdc);
  ccdc = document.createElement('input');
  ccdc.type = 'button';
  ccdc.id = fid + 'confirm';
  ccdc.value = disp_confirm;
  ccd.appendChild(ccdc);
  ccdc = document.createElement('input');
  ccdc.type = 'button';
  ccdc.id = fid + 'discard';
  ccdc.value = disp_discard;
  ccd.appendChild(ccdc);
  cdom.appendChild(ccd);
  return cdom;
}
function gendom_listchange(fid, val, items) {
  fid += '_'; // placeholder
  let chtml = '';
  let cdom = document.createElement('td');
  cdom.id = fid + 'td';
  cdom.style.backgroundColor = items[val]['color'];
  let ccd, ccdc;
  ccd = document.createElement('span');
  ccd.id = fid + 'cval';
  ccd.title = items[val]['desc'];
  ccd.innerText = items[val]['name'];
  cdom.appendChild(ccd);
  ccd = document.createElement('span');
  ccd.id = fid + 'edit';
  ccd.className = 'inithide';
  ccdc = document.createElement('select');
  ccdc.id = fid + 'new';
  ccdc.setAttribute('data-orig', val);
  Object.keys(items).forEach(key => {
    if (key == val) {
      chtml += "<option value='" + key + "' selected>" + items[key]['name'] + "</option>";
    } else {
      chtml += "<option value='" + key + "'>" + items[key]['name'] + "</option>";
    }
  });
  ccdc.innerHTML = chtml;
  ccd.appendChild(ccdc);
  ccdc = document.createElement('input');
  ccdc.type = 'button';
  ccdc.id = fid + 'confirm';
  ccdc.value = disp_confirm;
  ccd.appendChild(ccdc);
  ccdc = document.createElement('input');
  ccdc.type = 'button';
  ccdc.id = fid + 'discard';
  ccdc.value = disp_discard;
  ccd.appendChild(ccdc);
  cdom.appendChild(ccd);
  return cdom;
}
function change_start(e) {
  let cid = e.currentTarget.id.substr(0, e.currentTarget.id.length - 2);
  document.getElementById(cid + "cval").style.display = "none";
  document.getElementById(cid + "edit").style.display = "inline";
}
function change_confirm(e) {
  let fid = e.currentTarget.id.substr(0, e.currentTarget.id.length - 7);
  // exec commit and update following server reply, remove all following lines
  document.getElementById(fid + "cval").style.display = "inline";
  document.getElementById(fid + "edit").style.display = "none";
  if (document.getElementById(fid + "new").tagName == 'SELECT') {
    document.getElementById(fid + "cval").innerText = c_labels[document.getElementById(fid + "new").value]['name'];
  } else {
    document.getElementById(fid + "cval").innerText = document.getElementById(fid + "new").value;
  }
  e.stopPropagation();
}
function change_discard(e) {
  let fid = e.currentTarget.id.substr(0, e.currentTarget.id.length - 7);
  document.getElementById(fid + "cval").style.display = "inline";
  document.getElementById(fid + "edit").style.display = "none";
  if (document.getElementById(fid + "new").tagName == 'SELECT') {
    document.getElementById(fid + "cval").innerText = c_labels[document.getElementById(fid + "new").value]['name'];
  } else {
    document.getElementById(fid + "cval").innerText = document.getElementById(fid + "new").value;
  }
  e.stopPropagation();
}
function text_item(hash, fid) {
  if (hash[fid] != undefined) { return hash[fid]; } else { return ''; }
}
function draw_fieldhead(res = null) {
  if (res != null) { c_fields = res; }
  let chtml = '';
  chtml += '<tr>';
  chtml += '<th></th>'; // showup
  cur_thead = Object.keys(c_fields);
  cur_thead.forEach(fid => {
    chtml += '<th>' + c_fields[fid][c_lang]['label'] + '</th>';
  })
  chtml += '<th></th>'; // label
  chtml += '<th></th>'; // links
  chtml += '</tr>';
  document.getElementById('list_head').innerHTML = chtml;
}
function draw_reginfo(res = null) {
  if (res != null) { cur_reg = res; }
  cur_reg.forEach(reg => {
    let crow = document.createElement('tr');
    crow.id = line_head + reg['id'] + '_tr';
    draw_regline(crow, reg);
    document.getElementById('list_body').appendChild(crow);
    event_regline(reg);
  });
}
function draw_regline(crow, res) {
  let cid = line_head + res['id'] + '_';
  let celem;
  celem = document.createElement('td');
  celem.innerText = text_item(res, 'show');
  crow.appendChild(celem);
  cur_thead.forEach(fid => { crow.appendChild(gendom_textchange(cid + fid, text_item(res, fid))); });
  crow.appendChild(gendom_listchange(cid + 'label', text_item(res, 'label'), c_labels));
  celem = document.createElement('td');
  crow.appendChild(celem);
};
function event_regline(res) {
  let cid = line_head + res['id'] + '_';
  cur_thead.forEach(fid => {
    document.getElementById(cid + fid + '_td').addEventListener('click', change_start);
    document.getElementById(cid + fid + '_confirm').addEventListener('click', change_confirm);
    document.getElementById(cid + fid + '_discard').addEventListener('click', change_discard);
  });
  document.getElementById(cid + 'label_td').addEventListener('click', change_start);
  document.getElementById(cid + 'label_confirm').addEventListener('click', change_confirm);
  document.getElementById(cid + 'label_discard').addEventListener('click', change_discard);
}
window.addEventListener('load', () => {
  get_data(api_fieldinfo, '', draw_fieldhead);
  get_data(api_labels, '', (res) => { c_labels = res; });
  get_data(api_reginfo, '', draw_reginfo);
});
-->
  </script>
</head>
<body>
<h1>登録者一覧・編集画面</h1>
<p>
  このページはモックです。表示されているデータはテスト用の静的なデータファイルを参照しており、編集しても更新されません。
</p>
<table>
  <thead id="list_head"></thead>
  <tbody id="list_body"></tbody>
</table>
</body>
</html>